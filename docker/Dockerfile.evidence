FROM node:20-slim

WORKDIR /evidence

COPY ./evidence/ .

ENV NODE_OPTIONS=--max-old-space-size=512
RUN npm install --prefer-offline --no-audit --no-fund
RUN npm rebuild sqlite3
RUN npm install -g serve

EXPOSE 3000

# At runtime: source the DuckDB data, build static site, then serve it
CMD ["/bin/sh", "-c", "npm run sources && npm run build && serve build -p 3000"]