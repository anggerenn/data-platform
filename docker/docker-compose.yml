# docker/docker-compose.yml
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: prefect
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-prefect}
      POSTGRES_DB: prefect
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - data-network
    restart: unless-stopped

  prefect-server:
    image: prefecthq/prefect:3.4.25-python3.12
    depends_on:
      - postgres
    environment:
      PREFECT_API_DATABASE_CONNECTION_URL: postgresql+asyncpg://prefect:${POSTGRES_PASSWORD:-prefect}@postgres:5432/prefect
      PREFECT_SERVER_API_HOST: 0.0.0.0
    command: prefect server start
    networks:
      - data-network
    restart: unless-stopped

  prefect-worker:
    build:
      context: .
      dockerfile: docker/Dockerfile.prefect
    depends_on:
      - prefect-server
    environment:
      PREFECT_API_URL: "http://prefect-server:4200/api"
      ANALYTICS_DB_PATH: "/data/analytics.duckdb"
      ANALYTICS_PIPELINES_DIR: "/data/pipelines"
    command: prefect worker start --pool default-pool
    volumes:
      - ./dbt:/opt/prefect/dbt
      - ./prefect:/opt/prefect/flows
      - ./evidence:/opt/prefect/evidence
      - /data:/data
      - evidence_build:/opt/prefect/evidence/.evidence/template/static
    networks:
      - data-network
    restart: unless-stopped
  
  nginx:
    image: nginx:alpine
    volumes:
      - evidence_build:/usr/share/nginx/html
    networks:
      - data-network
    restart: unless-stopped

volumes:
  postgres_data:
  evidence_build:

networks:
  data-network:
    driver: bridge